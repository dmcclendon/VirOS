#!/bin/bash

#
# This script is an ugly hack, for too many reasons.
#
# Basically to minimize the size of the overlay.f8 trait/patch, this script is utilized to bring
# vol_id, sed, find, touch, and findfs into the initrd.  They are pulled from a temporary expanded
# version of the f8 live rootfs, instead of being duplicately packaged.  Unfortunately library
# dependencies are explicit here, rather than being autogenerated via ldd.
#
# In general the lixmog method of 'patching' livecd isos is very cool and useful.  Unfortunately
# this particular case is pretty gross, and ideally temporary until such a feature is merged
# upstream.  Then, lixmog can evolve into the tool it really is meant to be, i.e. something that
# can very easily (as non-root) add a music library to a livecd, or add some rpms to a livecd.
#

##
## standard f8 lixmog aliases for the locations of things in the lixmog expanded livecd tree
##
# note: the .img-lixmog-expanded convention.  Ideally lixmog will become de-f8 hard-coded,
# and all .img files will be expanded if they are filesystem or initramfs images.
ISOFS="/scratch/expanded/isofs"
INITRAMFS="${ISOFS}/isolinux/initrd0.img.lixmog-expanded"
ROOTFS="${ISOFS}/LiveOS/squashfs.img.lixmog-expanded/LiveOS/ext3fs.img.lixmog-expanded"

echo "ZyX.overlay.f8 lixmog trait post script starting..."


##
## yet another gross workaround: no patch on the f8 livecd, so use it here
##
cp -v \
    ${ROOTFS}/etc/rc.d/init.d/functions \
    ${INITRAMFS}/etc_rc.d_init.d_functions.patched
patch \
    ${INITRAMFS}/etc_rc.d_init.d_functions.patched \
    ${INITRAMFS}/etc_rc.d_init.d_functions.patch \

cp -v \
    ${ROOTFS}/etc/rc.d/init.d/halt \
    ${INITRAMFS}/etc_rc.d_init.d_halt.patched
patch \
    ${INITRAMFS}/etc_rc.d_init.d_halt.patched \
    ${INITRAMFS}/etc_rc.d_init.d_halt.patch \

##
## extra programs needed by findoverlay
##
cp -v \
    ${ROOTFS}/usr/bin/find \
    ${INITRAMFS}/bin/find

cp -v \
    ${ROOTFS}/bin/sed \
    ${INITRAMFS}/bin/sed

cp -v \
    ${ROOTFS}/sbin/findfs \
    ${INITRAMFS}/sbin/findfs

cp -v \
    ${ROOTFS}/bin/touch \
    ${INITRAMFS}/bin/touch

# note: not using habitual cp -a as links need to be copied as files

# these libs are for findfs
cp -v \
    ${ROOTFS}/lib/libe2p.so.2 \
    ${INITRAMFS}/lib/

cp -v \
    ${ROOTFS}/lib/libcom_err.so.2 \
    ${INITRAMFS}/lib/

cp -v \
    ${ROOTFS}/lib/libext2fs.so.2 \
    ${INITRAMFS}/lib/

##
## extra kernel modules needed for findoverlay
## (basically vfat to find the overlay on a typical usbstick)
##

# note: the * should/will work assuming a single installed kernel
cp -av \
    ${ROOTFS}/lib/modules/*/kernel/fs/fat/fat.ko \
    ${INITRAMFS}/lib/modules/*/

cp -av \
    ${ROOTFS}/lib/modules/*/kernel/fs/vfat/vfat.ko \
    ${INITRAMFS}/lib/modules/*/

exit 0

